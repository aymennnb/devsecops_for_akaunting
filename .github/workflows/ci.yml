name: Akaunting DevSecOps CI/CD

env:
  MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
  MYSQL_USER: ${{ secrets.MYSQL_USER }}
  MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
  APP_ENV: testing

on:
  push:
    branches: [main]

jobs:
  install-dependencies:
    name: install Project dependencies
    runs-on: ubuntu-latest

    services:
      mysql-service:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-scripts

      - name: Install npm dependencies
        run: npm install

      - name: Setup application environment
        run: |
            echo "== Configuration de l'environnement... =="

            cp .env.example .env
            php artisan key:generate

            sed -i "s/APP_ENV=.*/APP_ENV=${{ env.APP_ENV }}/" .env
            sed -i "s/APP_DEBUG=.*/APP_DEBUG=true/" .env
            sed -i "s/DB_HOST=.*/DB_HOST=127.0.0.1/" .env
            sed -i "s/DB_PORT=.*/DB_PORT=3306/" .env
            sed -i "s/DB_DATABASE=.*/DB_DATABASE=${{ env.MYSQL_DATABASE }}/" .env
            sed -i "s/DB_USERNAME=.*/DB_USERNAME=${{ env.MYSQL_USER }}/" .env
            sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${{ env.MYSQL_PASSWORD }}/" .env

            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p bootstrap/cache

      - name: Wait for MySQL to be ready
        env:
          MYSQL_PWD: ${{ env.MYSQL_PASSWORD }}
        run: |
          echo "== Attente de MySQL... =="
          until mysqladmin -h 127.0.0.1 -u${{ env.MYSQL_USER }} ping 2>/dev/null; do
            echo "En attente de MySQL..."
            sleep 2
          done
          echo "== MySQL est prêt =="

      - name: Setup Database
        env:
          MYSQL_PWD: ${{ env.MYSQL_PASSWORD }}
        run: |
          echo "== Configuration de la base de données... =="
          mysql -h 127.0.0.1 -u${{ env.MYSQL_USER }} -e "CREATE DATABASE IF NOT EXISTS ${{ env.MYSQL_DATABASE }};"
          php artisan migrate --force
          echo "== Base de données configurée =="


#  run-tests:
#    name: unit & feature tests
#    runs-on: ubuntu-latest
#    needs: install-dependencies
#    continue-on-error: true
#
#    services:
#      mysql:
#        image: mysql:8.0
#        env:
#          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
#          MYSQL_USER: ${{ secrets.MYSQL_USER }}
#          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
#          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
#
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Setup PHP
#        uses: shivammathur/setup-php@v2
#        with:
#          php-version: '8.3'
#
#      - uses: actions/cache@v3
#        with:
#          path: vendor
#          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
#
#      - name: Check dependencies
#        run: |
#          if [ ! -d "vendor" ]; then
#            echo "== vendor non trouvé, installation... =="
#            composer install --no-scripts
#          else
#            echo "== Utilisation du cache Composer =="
#          fi
#
#      - name: Setup test environment
#        run: |
#          echo "== Configuration de l'environnement de test... =="
#          cp .env.example .env.testing
#          php artisan key:generate --env=testing
#          sed -i "s/DB_HOST=.*/DB_HOST=127.0.0.1/" .env.testing
#          sed -i "s/DB_DATABASE=.*/DB_DATABASE=${{ secrets.MYSQL_DATABASE }}/" .env.testing
#
#      - name: Run unit tests
#        run: |
#          echo "== Lancement des tests unitaires... =="
#          vendor/bin/phpunit --testsuite Unit --log-junit unit-report.xml
#          echo "== Tests unitaires terminés =="
#        continue-on-error: true
#
##      - name: Run feature tests
##        run: |
##          echo "== Lancement des tests fonctionnels... =="
##          vendor/bin/phpunit --testsuite Feature --log-junit feature-report.xml
##          echo "== Tests fonctionnels terminés =="
##        continue-on-error: true
#
#      - name: Upload test reports
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#            name: test-reports-${{ github.run_id }}
#            path: |
#              unit-report.xml
##              feature-report.xml

  semgrep-sast:
    name: SAST Security avec Semgrep
    runs-on: ubuntu-latest
    needs: install
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create directories
        run: |
          mkdir -p "GitHub Actions/SAST Security/Reports"

      - name: Run Semgrep SAST
        run: |
          python -m pip install semgrep

          semgrep ci --config=auto --json > "GitHub Actions/SAST Security/Reports/semgrep-general.json"
          echo "== Scan général terminé =="

          semgrep ci --config=p/owasp-top-ten --json > "GitHub Actions/SAST Security/Reports/semgrep-owasp.json"
          echo "== Scan OWASP terminé =="

          semgrep ci --config=p/laravel --json > "GitHub Actions/SAST Security/Reports/semgrep-laravel.json"
          echo "== Scan Laravel terminé =="

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports-${{ github.sha }}
          path: |
            GitHub Actions/SAST Security/Reports/
          retention-days: 7

#  scan:
#    name: Scan docker image with Trivy
#    runs-on: ubuntu-latest
#    needs: build
#    env:
#      DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME }}
#      IMAGE_TAG: ${{ github.sha }}
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#
#      - name: Download Docker image artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: docker-image-${{ env.DOCKER_IMAGE_NAME }}-${{ github.sha }}
#          path: ./
#
#      - name: Load Docker image from tar file
#        run: |
#          echo "=== Chargement de l'image Docker depuis le fichier tar ==="
#          docker load -i docker-image.tar
#          echo "== Images chargées =="
#          docker images
#
#      - name: Set Date
#        id: set-date
#        run: echo "DATE=$(date +%m.%d.%Y)" >> $GITHUB_ENV
#
#      - name: Create output directory
#        run: mkdir -p "GitHub Actions/Trivy Automation"
#
#      - name: Install Trivy
#        run: |
#          sudo apt-get update
#          sudo apt-get install -y curl
#          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.57.0
#
#      - name: Download Trivy vulnerability database
#        run: trivy image --download-db-only
#
#      - name: Run Trivy vulnerability scanner
#        run: |
#          OUTPUT_FILE="GitHub Actions/Trivy Automation/scan-results-${DATE}.json"
#          mkdir -p "GitHub Actions/Trivy Automation"
#          trivy image --format json --ignore-unfixed --vuln-type os,library --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" ${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
#
#      - name: Upload scan results as artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: trivy-scan-results-${{ env.DATE }}
#          path: GitHub Actions/Trivy Automation/
#          retention-days: 7


#  push:
#    runs-on: ubuntu-latest
#    needs: build
#    env:
#      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
#      DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME}}
#      DOCKERHUB_TAG: ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ github.sha }}
#
#    steps:
#      - name: Download Docker image artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: docker-image-${{ env.DOCKER_IMAGE_NAME }}-${{ github.sha }}
#          path: ./
#
#      - name: Load Docker image from tar file
#        run: |
#            echo "=== Chargement de l'image Docker depuis le fichier tar ==="
#            docker load -i docker-image.tar
#            echo "== Images chargée =="
#             docker images
#
#      - name: Login to Docker Hub
#        uses: docker/login-action@v3
#        with:
#            username: ${{ env.DOCKERHUB_USERNAME }}
#            password: ${{ secrets.DOCKERHUB_PASSWORD }}
#
#      - name: Tag image for Docker Hub
#        run: |
#            echo "=== Tag de l'image pour Docker Hub ==="
#            docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} ${{ env.DOCKERHUB_TAG }}
#            echo "== Images taggées =="
#            docker images | grep ${{ env.DOCKERHUB_USERNAME }}
#
#      - name: Push to Docker Hub
#        run: |
#            echo "=== Push vers Docker Hub ==="
#            docker push ${{ env.DOCKERHUB_TAG }}
#            echo "== Images poussées avec succès =="
